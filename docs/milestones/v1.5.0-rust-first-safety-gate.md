# Milestone: v1.5.0 – Rust-First Safety Gate

**Due Date**: TBD (recommend 6-8 weeks from start)

## Description

Production-grade one-shot installer with Rust-first architecture. Eliminates external command dependencies where viable while maintaining safety guarantees.

---

## Key Deliverables

### Phase 1: Foundation Hardening (Release Blockers)

- [ ] **WO-101**: Unified error hierarchy (`MashError` + `HalError` consolidated)
- [ ] **WO-102**: Idempotency guards for mount/unmount/format operations
- [ ] **WO-103**: RAII cleanup guards (`MountGuard`, `LoopGuard`)
- [ ] **WO-104**: Replace `sync` command with `libc::sync()` syscall
- [ ] **WO-105**: Eliminate critical `unwrap()`/`expect()` panic points (target: <50)
- [ ] **WO-106**: Unify nix crate version to 0.29 workspace-wide

### Phase 2: Native Sysfs Probing

- [ ] **WO-201**: Replace `lsblk` with `/sys/block/` parsing
- [ ] **WO-202**: Replace `blkid` with `/dev/disk/by-uuid/` symlinks
- [ ] **WO-203**: Replace `udevadm settle` with netlink monitoring
- [ ] **WO-204**: Add stable disk identifiers (serial/model) to TUI

### Phase 3: Native Loop & Wipe

- [ ] **WO-301**: Replace `losetup` with loop device ioctls (`LOOP_CTL_GET_FREE`, `LOOP_SET_FD`)
- [ ] **WO-302**: Replace `wipefs` with direct sector zeroing
- [ ] **WO-303**: Add `BLKRRPART` ioctl for partition re-read

---

## Success Metrics

| Metric | v1.4.0 (Current) | v1.5.0 (Target) |
|--------|------------------|-----------------|
| External commands | 14 | 8 |
| `unwrap()`/`expect()` instances | 154 | <50 |
| Idempotent operations | Partial | Full |
| RAII resource cleanup | None | Complete |
| Error type hierarchies | 2 (duplicated) | 1 (unified) |

---

## Non-Goals for v1.5.0

These are explicitly **out of scope** and deferred to v1.6.0+:

- Native `mkfs.ext4` (no viable Rust crate)
- Native `mkfs.btrfs` (no viable Rust crate)
- Native GPT/MBR partitioning (Phase 4)
- Native FAT32 formatting (Phase 5)
- Native copy tree replacing rsync (Phase 6)
- TUI refactor/split (Phase 7)

---

## Acceptance Criteria

### Must Pass Before Release

1. `cargo test --all-features` passes
2. `cargo clippy --all-targets --all-features -- -D warnings` passes
3. CI pipeline green (including maelstrom isolated tests)
4. Dry-run full pipeline completes without errors
5. Manual test on Pi 4B (1GB and 4GB variants)
6. All Phase 1-3 work orders completed

### Documentation Requirements

- [ ] CHANGELOG.md updated with breaking changes
- [ ] CLAUDE.md updated with new architecture notes
- [ ] Migration guide for any API changes

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Kernel ioctl compatibility | Test on kernel 5.x and 6.x |
| sysfs parsing edge cases | Validate against known Pi hardware |
| Netlink race conditions | Add timeout + retry logic |
| Memory regression on 1GB Pi | Profile with heaptrack before release |

---

## Reference Documents

- `docs/ENGINEERING_REVIEW_CLAUDE.md` - Full third-party review
- `docs/REFACTOR_PLAN.md` - Detailed implementation plan
- `docs/DOJO.md` - Core development principles

---

## GitHub Milestone Creation

To create this milestone via GitHub CLI:

```bash
gh milestone create "v1.5.0 – Rust-First Safety Gate" \
  --description "Production-grade one-shot installer with Rust-first architecture. Eliminates external command dependencies where viable." \
  --due-date "2026-03-31"
```

To create via GitHub API:

```bash
curl -X POST \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  https://api.github.com/repos/drtweak86/MASH/milestones \
  -d '{
    "title": "v1.5.0 – Rust-First Safety Gate",
    "description": "Production-grade one-shot installer with Rust-first architecture.",
    "due_on": "2026-03-31T00:00:00Z"
  }'
```
